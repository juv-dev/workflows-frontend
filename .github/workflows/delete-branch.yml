name: Delete Branch After Tag

on:
  workflow_run:
    workflows: ["Create Tag"]
    types: [completed]
  repository_dispatch:
    types: [delete_branch]

jobs:
  delete-branch:
    if: >-
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'pull_request' &&
       github.event.workflow_run.event.pull_request.merged == true) ||
      (github.event_name == 'repository_dispatch' && 
       github.event.action == 'delete_branch')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR information
        if: github.event_name == 'workflow_run'
        id: pr_info
        uses: actions/github-script@v6
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.workflow_run.event.pull_request.number
            });
            return {
              branch: pr.head.ref
            };
      
      - name: Delete branch
        uses: dawidd6/action-delete-branch@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branches: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch || steps.pr_info.outputs.branch }}