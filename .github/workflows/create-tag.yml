name: Create Tag

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
    secrets:
      repo_token:
        required: true

jobs:
  tag-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    outputs:
      tag: ${{ steps.create_tag.outputs.tag || '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}
          token: ${{ secrets.repo_token }}

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: true

      - name: Ensure package.json exists and read version
        id: read_version
        run: |
          set -euo pipefail
          if [ ! -f package.json ]; then
            echo "error=package_json_missing" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Abort if package.json missing
        if: steps.read_version.outputs.error == 'package_json_missing'
        run: |
          echo "package.json not found in the merge commit â€” nothing to tag."
          exit 0

      - name: Fetch all git history and tags
        run: |
          git fetch --unshallow
          git fetch --tags

      - name: Check if tag exists
        id: check_tag
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          if git rev-parse -q --verify "refs/tags/v$VERSION" >/dev/null || \
             git ls-remote --exit-code --tags origin "refs/tags/v$VERSION" >/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Get last tag
        id: last_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "v0.0.0")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

      - name: Create and push tag if version is greater
        id: create_tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          LAST_TAG="${{ steps.last_tag.outputs.last_tag }}"
          
          # Remove 'v' prefix for comparison
          VERSION_NUM=${VERSION#v}
          LAST_TAG_NUM=${LAST_TAG#v}
          
          # Compare versions
          if [ "$(printf '%s\n' "$VERSION_NUM" "$LAST_TAG_NUM" | sort -V | head -n1)" = "$VERSION_NUM" ] && [ "$VERSION_NUM" != "$LAST_TAG_NUM" ]; then
            echo "Version $VERSION is not greater than last tag $LAST_TAG. Skipping tag creation."
            echo "tag=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create and push tag
          TAG="v$VERSION"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "Created and pushed tag $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Tag already exists
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "Tag v${{ steps.read_version.outputs.version }} already exists. Nothing to do."