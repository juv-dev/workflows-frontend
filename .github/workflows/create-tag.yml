name: Tag on merge (from package.json)

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  tag-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write

    outputs:
      tag: ${{ steps.create_tag.outputs.tag || '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Ensure package.json exists and read version
        id: read_version
        run: |
          set -euo pipefail
          if [ ! -f package.json ]; then
            echo "error=package_json_missing" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Abort if package.json missing
        if: steps.read_version.outputs.error == 'package_json_missing'
        run: |
          echo "package.json not found in the merge commit â€” nothing to tag."
          exit 0

      - name: Fetch remote tags
        run: |
          git fetch --tags --quiet

      - name: Check remote for existing tag matching package.json version
        id: check_tag
        run: |
          set -euo pipefail
          VERSION="${{ steps.read_version.outputs.version }}"
          if git ls-remote --tags origin | grep -q "refs/tags/v${VERSION}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Get last remote tag (or v0.0.0)
        id: last_tag
        run: |
          set -euo pipefail
          # Ensure tags are fetched (already done), then list and sort by semver-aware refname
          LAST=$(git tag --list 'v*' --sort=-v:refname | head -n1 || true)
          if [ -z "$LAST" ]; then LAST="v0.0.0"; fi
          echo "last_tag=$LAST" >> $GITHUB_OUTPUT

      - name: Validate version is greater than last tag and create tag
        id: create_tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          set -euo pipefail
          VERSION="${{ steps.read_version.outputs.version }}"
          LAST="${{ steps.last_tag.outputs.last_tag }}"

          echo "Package.json version: $VERSION"
          echo "Last remote tag: $LAST"

          # Parse semver components
          parse() {
            v="${1#v}"
            IFS='.' read -r a b c <<< "$v"
            echo "${a:-0} ${b:-0} ${c:-0}"
          }
          read -r A B C <<< "$(parse "$VERSION")"
          read -r LA LB LC <<< "$(parse "$LAST")"

          greater=false
          if [ "$A" -gt "$LA" ]; then
            greater=true
          elif [ "$A" -eq "$LA" ] && [ "$B" -gt "$LB" ]; then
            greater=true
          elif [ "$A" -eq "$LA" ] && [ "$B" -eq "$LB" ] && [ "$C" -gt "$LC" ]; then
            greater=true
          fi

          if [ "$greater" != "true" ]; then
            echo "package.json version ($VERSION) is NOT greater than last tag ($LAST). Skipping tag creation."
            echo "tag=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TAG="v${VERSION}"
          # Create an annotated tag and push it
          git tag -a "$TAG" -m "release: $TAG"
          git push origin "$TAG"
          echo "Created and pushed tag $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Tag already exists
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "Tag v${{ steps.read_version.outputs.version }} already exists. Nothing to do."